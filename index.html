<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFmpeg è§†é¢‘è£å‰ªåŠ©æ‰‹ (å¸¦æ—¶é—´è½´)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <style>
        /* å…¨å±æ·±è‰²å¸ƒå±€ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #1a1a1a;
            color: #efefef;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* 1. é¡¶éƒ¨ Header */
        header {
            flex: 0 0 50px;
            background-color: #252525;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
        }
        h1 { margin: 0; font-size: 16px; font-weight: 500; color: #ddd; }
        
        .header-btn {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            border: none;
        }
        .header-btn:hover { background: #2980b9; }
        input[type="file"] { display: none; }

        /* 2. ä¸­é—´ç”»å¸ƒ Stage */
        #editor-stage {
            flex: 1;
            position: relative;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .empty-state {
            text-align: center;
            color: #666;
            border: 2px dashed #444;
            padding: 40px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .empty-state:hover { border-color: #888; }
        
        .img-container {
            width: 100%;
            height: 100%;
            display: none; /* åˆå§‹éšè— */
        }
        img { display: block; max-width: 100%; }

        /* åŠ è½½é®ç½© */
        #loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            display: none;
        }
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px; height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 3. è§†é¢‘æ§åˆ¶æ¡ (æ–°å¢) */
        #video-controls {
            flex: 0 0 40px;
            background-color: #2d2d2d;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰æ˜¯è§†é¢‘æ—¶æ‰æ˜¾ç¤º */
        }
        
        .time-display {
            font-family: monospace;
            font-size: 12px;
            color: #aaa;
            min-width: 100px;
        }

        /* è‡ªå®šä¹‰æ»‘å—æ ·å¼ */
        input[type=range] {
            -webkit-appearance: none;
            flex: 1;
            background: transparent;
            cursor: pointer;
        }
        input[type=range]:focus { outline: none; }
        
        /* æ»‘å—è½¨é“ */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
        }
        /* æ»‘å—æŒ‰é’® */
        input[type=range]::-webkit-slider-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3498db;
            -webkit-appearance: none;
            margin-top: -5px; /* å±…ä¸­ */
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* 4. åº•éƒ¨ Footer (æŒ‡ä»¤åŒº) */
        footer {
            flex: 0 0 60px;
            background-color: #252525;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            z-index: 100;
        }

        .cmd-group { flex: 1; display: flex; gap: 10px; }
        
        input.cmd-input {
            flex: 1;
            background: #111;
            border: 1px solid #444;
            color: #50fa7b;
            font-family: 'Consolas', monospace;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }
        
        .info-text {
            font-size: 12px; color: #888; text-align: right; min-width: 140px; line-height: 1.4;
        }

        .copy-btn {
            background: #27ae60; color: white; border: none; padding: 0 20px;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px;
        }
        .copy-btn:hover { background: #219150; }

    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>FFmpeg è£å‰ªåŠ©æ‰‹</h1>
        <div>
            <label for="file-upload" class="header-btn">ğŸ“‚ å¯¼å…¥æ–‡ä»¶</label>
            <input id="file-upload" type="file" accept="image/*,video/*"/>
        </div>
    </header>

    <div id="editor-stage">
        <div class="empty-state" id="drop-zone" onclick="document.getElementById('file-upload').click()">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸï¸</div>
            <p>ç‚¹å‡»ä¸Šä¼  æˆ– æ‹–æ‹½è§†é¢‘/å›¾ç‰‡</p>
        </div>
        
        <div id="loading-overlay"><div class="spinner"></div></div>

        <div class="img-container" id="img-wrapper">
            <img id="image" src="" alt="Source">
        </div>
    </div>

    <div id="video-controls">
        <span class="time-display" id="current-time">00:00.0</span>
        <input type="range" id="seek-bar" min="0" value="0" step="0.1">
        <span class="time-display" id="total-duration" style="text-align: right;">00:00.0</span>
    </div>

    <footer>
        <div class="info-text" id="resolution-info">ç­‰å¾…å¯¼å…¥...</div>
        <div class="cmd-group">
            <input type="text" class="cmd-input" id="ffmpeg-cmd" readonly placeholder="-vf 'crop=...'">
            <button class="copy-btn" onclick="copyCommand()">å¤åˆ¶</button>
        </div>
    </footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    // DOM å…ƒç´ å¼•ç”¨
    const els = {
        fileInput: document.getElementById('file-upload'),
        image: document.getElementById('image'),
        imgWrapper: document.getElementById('img-wrapper'),
        dropZone: document.getElementById('drop-zone'),
        cmdInput: document.getElementById('ffmpeg-cmd'),
        infoText: document.getElementById('resolution-info'),
        loading: document.getElementById('loading-overlay'),
        videoControls: document.getElementById('video-controls'),
        seekBar: document.getElementById('seek-bar'),
        currTime: document.getElementById('current-time'),
        totalDur: document.getElementById('total-duration')
    };

    let cropper = null;
    let activeVideo = null; // ä¿å­˜å½“å‰çš„è§†é¢‘å¯¹è±¡
    let activeVideoUrl = null; // ä¿å­˜è§†é¢‘çš„ Blob URL ç”¨äºæ¸…ç†

    // --- å·¥å…·å‡½æ•° ---
    const formatTime = (seconds) => {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = Math.floor(seconds % 60).toString().padStart(2, '0');
        const ms = Math.floor((seconds % 1) * 10);
        return `${m}:${s}.${ms}`;
    };

    function toggleLoading(show) {
        els.loading.style.display = show ? 'flex' : 'none';
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---

    // 1. å¤„ç†æ–‡ä»¶å…¥å£
    async function processFile(file) {
        if (!file) return;
        
        // æ¸…ç†æ—§èµ„æº
        if (activeVideoUrl) {
            URL.revokeObjectURL(activeVideoUrl);
            activeVideo = null;
            activeVideoUrl = null;
        }
        if (cropper) cropper.destroy();

        toggleLoading(true);

        try {
            if (file.type.startsWith('video/')) {
                // å¤„ç†è§†é¢‘
                await initVideoMode(file);
            } else if (file.type.startsWith('image/')) {
                // å¤„ç†å›¾ç‰‡
                await initImageMode(file);
            } else {
                alert('ä»…æ”¯æŒå›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶');
                toggleLoading(false);
            }
        } catch (e) {
            console.error(e);
            alert('åŠ è½½å¤±è´¥: ' + e.message);
            toggleLoading(false);
        }
    }

    // 2. è§†é¢‘æ¨¡å¼åˆå§‹åŒ–
    async function initVideoMode(file) {
        activeVideoUrl = URL.createObjectURL(file);
        activeVideo = document.createElement('video');
        activeVideo.src = activeVideoUrl;
        activeVideo.muted = true;
        activeVideo.playsInline = true;

        // ç­‰å¾…å…ƒæ•°æ®åŠ è½½ä»¥è·å–æ—¶é•¿å’Œå°ºå¯¸
        await new Promise((resolve, reject) => {
            activeVideo.onloadedmetadata = () => resolve();
            activeVideo.onerror = () => reject(new Error('è§†é¢‘åŠ è½½å¤±è´¥'));
        });

        // è®¾ç½®UI
        els.videoControls.style.display = 'flex';
        els.seekBar.max = activeVideo.duration;
        els.seekBar.value = 0;
        els.totalDur.innerText = formatTime(activeVideo.duration);
        els.dropZone.style.display = 'none';
        els.imgWrapper.style.display = 'block';

        // æå–ç¬¬ä¸€å¸§å¹¶åˆå§‹åŒ– Cropper
        const frameData = await extractFrame(0);
        els.image.src = frameData;
        
        // ç­‰å¾…å›¾ç‰‡åŠ è½½åˆ° DOM
        els.image.onload = () => {
            initCropper();
            toggleLoading(false);
        };
        
        // ç»‘å®šæ»‘å—äº‹ä»¶
        setupVideoEvents();
    }

    // 3. å›¾ç‰‡æ¨¡å¼åˆå§‹åŒ–
    function initImageMode(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                els.videoControls.style.display = 'none'; // éšè—è§†é¢‘æ§ä»¶
                els.image.src = e.target.result;
                els.dropZone.style.display = 'none';
                els.imgWrapper.style.display = 'block';
                
                els.image.onload = () => {
                    initCropper();
                    toggleLoading(false);
                    resolve();
                };
            };
            reader.readAsDataURL(file);
        });
    }

    // 4. è§†é¢‘å¸§æå– (æ ¸å¿ƒ)
    function extractFrame(time) {
        return new Promise((resolve) => {
            // è®¾ç½®æ—¶é—´
            activeVideo.currentTime = time;

            // seeked äº‹ä»¶è§¦å‘è¯´æ˜è·³è½¬å®Œæˆï¼Œç”»é¢å·²æ›´æ–°
            activeVideo.onseeked = () => {
                const canvas = document.createElement('canvas');
                canvas.width = activeVideo.videoWidth;
                canvas.height = activeVideo.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(activeVideo, 0, 0, canvas.width, canvas.height);
                // è½¬æ¢ä¸ºå›¾ç‰‡URL
                resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
            
            // å¦‚æœå·²ç»åœ¨è¯¥æ—¶é—´ç‚¹ï¼Œæ‰‹åŠ¨è§¦å‘
            if (Math.abs(activeVideo.currentTime - time) < 0.1 && activeVideo.readyState >= 2) {
                activeVideo.onseeked();
            }
        });
    }

    // 5. è§†é¢‘æ»‘å—äº¤äº’
    function setupVideoEvents() {
        els.seekBar.oninput = async (e) => {
            const time = parseFloat(e.target.value);
            els.currTime.innerText = formatTime(time);
            
            // ç®€å•çš„é˜²æŠ–å¤„ç†ï¼Œé˜²æ­¢æ‹–åŠ¨å¤ªå¿«å¡é¡¿ (æ­¤å¤„ç›´æ¥æ‰§è¡Œï¼Œç°ä»£æµè§ˆå™¨å¤§å¤šèƒ½æ‰›ä½)
            if (activeVideo) {
                const frameUrl = await extractFrame(time);
                // é‡ç‚¹ï¼šreplace(url, true) ç¬¬äºŒä¸ªå‚æ•° true ä¿æŒè£å‰ªæ¡†ä½ç½®ä¸å˜
                if (cropper) {
                    cropper.replace(frameUrl, true); 
                }
            }
        };
    }

    // --- Cropper ç›¸å…³ ---
    function initCropper() {
        if (cropper) cropper.destroy();
        cropper = new Cropper(els.image, {
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 0.8,
            responsive: true,
            background: false, // è‡ªå®šä¹‰èƒŒæ™¯
            checkCrossOrigin: false,
            crop(event) { updateCmd(event.detail); },
            ready() { updateCmd(this.cropper.getData(true)); }
        });
    }

    function updateCmd(data) {
        const w = Math.round(data.width);
        const h = Math.round(data.height);
        const x = Math.round(data.x);
        const y = Math.round(data.y);
        
        // è·å–åŸå§‹åˆ†è¾¨ç‡
        const imgData = cropper.getImageData();
        const natW = Math.round(imgData.naturalWidth);
        const natH = Math.round(imgData.naturalHeight);

        els.cmdInput.value = `-vf 'crop=${w}:${h}:${x}:${y}'`;
        els.infoText.innerHTML = `åŸåˆ†è¾¨ç‡: ${natW}x${natH}<br>ä¿ç•™å°ºå¯¸: ${w}x${h}`;
    }

    // --- å…¨å±€äº¤äº’ ---
    function copyCommand() {
        els.cmdInput.select();
        document.execCommand('copy');
        const btn = document.querySelector('.copy-btn');
        const old = btn.innerText;
        btn.innerText = "OK";
        setTimeout(() => btn.innerText = old, 1000);
    }

    // æ‹–æ‹½ä¸ç²˜è´´
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                processFile(item.getAsFile());
                break;
            }
        }
    });

    const stage = document.getElementById('editor-stage');
    stage.addEventListener('dragover', (e) => { e.preventDefault(); els.dropZone.style.borderColor = '#3498db'; });
    stage.addEventListener('dragleave', (e) => { e.preventDefault(); els.dropZone.style.borderColor = '#444'; });
    stage.addEventListener('drop', (e) => { 
        e.preventDefault(); 
        els.dropZone.style.borderColor = '#444';
        if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
    });

    els.fileInput.addEventListener('change', (e) => {
        if(e.target.files.length) processFile(e.target.files[0]);
        e.target.value = '';
    });

</script>
</body>
</html>